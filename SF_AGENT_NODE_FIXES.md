# SF Agent 3 - Execute Command Node Fixes

## ✅ Issues Fixed

All three Execute Command nodes in **Workflow 3 - SF Agent 3 - Execute Changes** have been corrected.

### Problem
The nodes were created with the wrong type (`executeWorkflow`) instead of the correct type (`executeCommand`).

### Solution Applied
Updated all three nodes to use the correct `n8n-nodes-base.executeCommand` type.

---

## Node Details

### 1. Execute Command - Create Directory Structure

**Node ID**: `9ea45f0a-6fce-4e44-aa36-754ce6a48ffb`
**Type**: ✅ `n8n-nodes-base.executeCommand` (Fixed)
**Position**: After "Parse Generated Metadata"

**Command**:
```bash
# Create deployment directory structure
DEPLOY_DIR="{{ $json.deployDir }}"

# Clean and create fresh directory
rm -rf "$DEPLOY_DIR"
mkdir -p "$DEPLOY_DIR/force-app/main/default"
mkdir -p "$DEPLOY_DIR/manifest"

echo "Directory structure created at $DEPLOY_DIR"
```

**What it does**:
- Creates temporary directory (e.g., `/tmp/sf-deploy-PROJ-123`)
- Sets up Salesforce project structure
- Creates folders for metadata files and manifest

**Expression Variables Used**:
- `{{ $json.deployDir }}` - Deployment directory path from previous node

---

### 2. Execute Command - Execute Write Script

**Node ID**: `72e75cf4-c1b4-4304-9ac9-004d3f52fd69`
**Type**: ✅ `n8n-nodes-base.executeCommand` (Fixed)
**Position**: After "Bash - Write Metadata Files" (Code node)

**Command**:
```
={{ $json.writeScript }}
```

**What it does**:
- Executes the dynamically generated bash script from the previous Code node
- The script writes:
  - `package.xml` manifest file
  - All Salesforce metadata XML files (fields, validation rules, workflows, layouts)
  - Creates necessary subdirectories

**Expression Variables Used**:
- `={{ $json.writeScript }}` - Complete bash script generated by previous Code node

---

### 3. Execute Command - Validate Deployment

**Node ID**: `ac008cf8-1f48-4755-8239-d5a467a93e10`
**Type**: ✅ `n8n-nodes-base.executeCommand` (Fixed)
**Position**: After "Execute Command - Execute Write Script"

**Command**:
```bash
cd {{ $json.deployDir }} && sf project deploy start --source-dir force-app --target-org pratap.pattanayak@gmail.com --dry-run --json
```

**What it does**:
- Changes to deployment directory
- Runs Salesforce CLI validation (dry-run mode)
- Does NOT deploy - only validates metadata
- Returns JSON output for error checking

**Salesforce CLI Flags**:
- `--source-dir force-app` - Deploy all files in this directory
- `--target-org pratap.pattanayak@gmail.com` - Your authenticated org
- `--dry-run` - Validation only, no actual deployment
- `--json` - Returns structured JSON output

**Expression Variables Used**:
- `{{ $json.deployDir }}` - Deployment directory path

---

## Workflow Flow (Execute Command Section)

```
Parse Generated Metadata
  ↓
Execute Command - Create Directory Structure
  ↓ (creates /tmp/sf-deploy-{issueKey}/)
Bash - Write Metadata Files (Code node)
  ↓ (generates bash script)
Execute Command - Execute Write Script
  ↓ (writes all metadata files)
Execute Command - Validate Deployment
  ↓ (validates with Salesforce CLI --dry-run)
Check Validation Result (Code node)
  ↓
IF Validation Passed?
  ↓ (true)
Bash - Deploy to Salesforce
  ↓
Success Comment → Mark Done → Transition to Done
```

---

## Configuration in n8n UI

When you open **Workflow 3** in n8n, verify these three nodes:

### Node 1: Execute Command - Create Directory Structure
1. Click the node
2. **Type**: Should show "Execute Command"
3. **Command field**: Should contain the directory creation script
4. **Test**: The expression `{{ $json.deployDir }}` should be recognized

### Node 2: Execute Command - Execute Write Script
1. Click the node
2. **Type**: Should show "Execute Command"
3. **Command field**: Should show `={{ $json.writeScript }}`
4. **Note**: This is a dynamic command that comes from the previous node

### Node 3: Execute Command - Validate Deployment
1. Click the node
2. **Type**: Should show "Execute Command"
3. **Command field**: Should contain the `sf project deploy start --dry-run` command
4. **Important**: Make sure `--dry-run` flag is present (validation only)

---

## Prerequisites

For these Execute Command nodes to work, you need:

### 1. Salesforce CLI Installed
```bash
# Check if installed
sf --version

# Should return something like:
# @salesforce/cli/2.x.x
```

### 2. Authenticated Org
```bash
# Check authenticated orgs
sf org list

# Should show:
# pratap.pattanayak@gmail.com (Connected)
```

### 3. Execute Command Node Enabled

The Execute Command node may be disabled by default. Check your n8n environment variables:

**Option A: Docker/Environment Variables**
```bash
N8N_ENABLE_EXECUTE_COMMAND=true
```

**Option B: n8n Settings**
- Go to Settings in n8n
- Ensure "Execute Command" node is not restricted

---

## Testing the Fixed Nodes

### Test 1: Directory Creation
1. Manually trigger Workflow 3 (or use test execution)
2. Check the "Execute Command - Create Directory Structure" node output
3. Should see: `Directory structure created at /tmp/sf-deploy-{issueKey}`

### Test 2: Write Script Execution
1. Check the "Execute Command - Execute Write Script" node output
2. Should see: `All metadata files written successfully`
3. Verify files exist:
```bash
ls -la /tmp/sf-deploy-TEST-123/force-app/main/default/
```

### Test 3: Validation
1. Check the "Execute Command - Validate Deployment" node output
2. Should return JSON with validation results
3. Key fields to check:
   - `status`: Should be `0` (success) or error code
   - `result.status`: Should be `"Succeeded"` or error message

---

## Common Issues & Solutions

### Issue: "Execute Command node not found"
**Solution**:
- The node type is `n8n-nodes-base.executeCommand` (not "Bash")
- It's a built-in node in n8n
- If missing, update n8n to latest version

### Issue: "Permission denied" when creating directory
**Solution**:
- Ensure n8n has write permissions to `/tmp/`
- Check n8n process user permissions
- Try alternative directory: `/var/tmp/` or `~/tmp/`

### Issue: "sf: command not found"
**Solution**:
- Install Salesforce CLI: `npm install -g @salesforce/cli`
- Ensure SF CLI is in PATH for n8n process
- Restart n8n after installing SF CLI

### Issue: "Not authenticated to org"
**Solution**:
```bash
# Authenticate org
sf org login web --alias my-org

# Verify authentication
sf org list

# Test connection
sf org display --target-org pratap.pattanayak@gmail.com
```

### Issue: Validation fails with metadata errors
**Solution**:
- Check the AI-generated metadata in "Claude - Generate Metadata" node
- Verify XML syntax is correct
- Ensure API version matches (currently 64.0)
- Check required fields are present

---

## Verification Checklist

Before running the workflow, verify:

- [x] All 3 Execute Command nodes use correct type (`executeCommand`)
- [x] Commands contain proper Salesforce CLI syntax
- [x] Expression variables are correctly formatted (`{{ }}`)
- [x] Node connections are correct (see flow diagram above)
- [x] Salesforce CLI installed and in PATH
- [x] Org authenticated: `pratap.pattanayak@gmail.com`
- [x] Execute Command node enabled in n8n settings
- [x] Write permissions to `/tmp/` directory

---

## Next Steps

1. ✅ Nodes are now fixed
2. ⏳ Configure Jira API credentials
3. ⏳ Configure Anthropic API credentials
4. ⏳ Activate the workflow
5. ⏳ Test with a real Jira Story

See [SF_AGENT_SETUP_GUIDE.md](SF_AGENT_SETUP_GUIDE.md) for complete setup instructions.

---

## Summary

✅ **All three Execute Command nodes are now properly configured and ready to use!**

The nodes will:
1. Create temporary Salesforce deployment directory
2. Write AI-generated metadata files
3. Validate metadata with Salesforce CLI
4. If validation passes → Deploy to Salesforce
5. Post results back to Jira

The autonomous AI Salesforce developer agent is ready for testing once you complete credential setup and activate the workflows.
